{% extends "base.html" %}

{% block content %}
    <h1>{{ category.name }}</h1>
    <p>{{ category.description }}</p>

    <div class="card">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
                <button id="previousButton" class="btn btn-primary btn-lg" disabled>
                    <i class="fas fa-chevron-left"></i>
                </button>
                <h2 class="display-1 fw-bold" id="current_phrase"></h2>
                <button id="nextButton" class="btn btn-primary btn-lg">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>


    {#    <div id="timer">#}
    {#        Time remaining: <span id="time">{{ time }}</span> seconds#}
    {#    </div>#}

{% endblock %}

{% block scripts %}
    <script>
        $(document).ready(function () {
            var timeLeft = {{ time }};
            var countdown;
            var phrases = {{ category.entries | tojson }};
            var current_index = -1;

            let audioContext = new (window.AudioContext || window.webkitAudioContext)();
            let timerSound = null;

            fetch('{{ sound_url }}')
                .then(response => response.arrayBuffer())
                .then(arrayBuffer => audioContext.decodeAudioData(arrayBuffer))
                .then(audioBuffer => {
                    timerSound = audioBuffer;
                });

            function showPhrase(index) {
                $("#current_phrase").text(phrases[index]);
                current_index = index;
                // Disable "Previous" button if this is the first phrase
                $("#previousButton").prop('disabled', index === 0);
                // Disable "Next" button if this is the last phrase
                $("#nextButton").prop('disabled', index === phrases.length - 1);
            }

            // Show the first phrase initially
            showPhrase(0);

            $("#nextButton").click(function () {
                if (current_index < phrases.length - 1) {
                    showPhrase(current_index + 1);
                }
            });

            $("#previousButton").click(function () {
                if (current_index > 0) {
                    showPhrase(current_index - 1);
                }
            });

            countdown = setInterval(function () {
                timeLeft--;

                if (timerSound) {
                    let source = audioContext.createBufferSource();
                    source.buffer = timerSound;
                    source.playbackRate.value = 1 + ({{ time }} -timeLeft) / {{ time }};  // Speed up as time decreases
                    source.connect(audioContext.destination);
                    source.start();
                }

                document.getElementById('time').textContent = timeLeft;
                if (timeLeft <= 0) {
                    clearInterval(countdown);
                    window.location.href = "/times_up";
                }
            }, 1000);
        });
    </script>
{% endblock %}
